# OSF Stack — PostgreSQL + Gateway
# Namespace: osf
# Deploy: microk8s kubectl apply -f k8s/osf-stack.yaml

---
# Secret — managed via kubectl, NOT stored in YAML
# To create/update: kubectl create secret generic osf-secrets \
#   --from-literal=jwt-secret="$JWT_SECRET" \
#   --from-literal=db-password="$DB_PASSWORD" \
#   --from-literal=nr-pod-secret="$NR_POD_SECRET" \
#   --from-literal=llm-encryption-key="$LLM_ENCRYPTION_KEY" \
#   -n osf --dry-run=client -o yaml | kubectl apply -f -
# NEVER commit plaintext secrets to this file.

---
# PostgreSQL Deployment
# TODO: Add PV for persistent storage (needs sudo on k8sserv4)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: osf-postgres
  namespace: osf
  labels:
    app: osf-postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: osf-postgres
  template:
    metadata:
      labels:
        app: osf-postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              value: osf
            - name: POSTGRES_USER
              value: osf_admin
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: osf-secrets
                  key: DB_PASSWORD
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
      volumes:
        - name: data
          emptyDir:
            sizeLimit: 5Gi

---
# PostgreSQL ClusterIP Service (intern)
apiVersion: v1
kind: Service
metadata:
  name: osf-postgres
  namespace: osf
  labels:
    app: osf-postgres
spec:
  selector:
    app: osf-postgres
  ports:
    - port: 5432

---
# PostgreSQL NodePort REMOVED (S2: DB was exposed on NodePort 30440)
# Use kubectl port-forward for dev access instead:
#   kubectl port-forward svc/osf-postgres 5432:5432 -n osf

---
# Gateway ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: osf-gateway-config
  namespace: osf
  labels:
    app: osf-gateway
data:
  NODE_ENV: production
  # DATABASE_URL is constructed at runtime from DB_HOST, DB_PORT, DB_PASSWORD env vars
  # Never hardcode credentials in ConfigMaps
  MCP_URL: "http://factory-v3-fertigung.factory.svc.cluster.local:8020"
  MCP_URL_ERP: "http://factory-v3-fertigung.factory.svc.cluster.local:8020"
  MCP_URL_OEE: "http://factory-v3-fertigung.factory.svc.cluster.local:8020"
  MCP_URL_QMS: "http://factory-v3-fertigung.factory.svc.cluster.local:8020"
  MCP_URL_TMS: "http://factory-v3-fertigung.factory.svc.cluster.local:8020"
  MCP_URL_UNS: "http://factory-v3-fertigung.factory.svc.cluster.local:8025"
  MCP_URL_KG: "http://factory-v3-fertigung.factory.svc.cluster.local:8020"
  FACTORY_SIM_URL: "http://factory-v3-fertigung.factory.svc.cluster.local:8888"
  LLM_URL_FREE: "http://192.168.178.120:5002"
  LLM_URL_PREMIUM: "http://192.168.178.120:5001"
  LLM_MODEL: "qwen2.5-14b-instruct-q4_k_m.gguf"
  LLM_MODEL_PREMIUM: "Qwen2.5-72B-Instruct.Q4_K_M.gguf"

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: osf-gateway
  namespace: osf
  labels:
    app: osf-gateway
spec:
  replicas: 2
  selector:
    matchLabels:
      app: osf-gateway
  template:
    metadata:
      labels:
        app: osf-gateway
    spec:
      containers:
        - name: osf-gateway
          image: localhost:32000/osf-gateway:v2
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
              name: http
          envFrom:
            - configMapRef:
                name: osf-gateway-config
          env:
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: osf-secrets
                  key: JWT_SECRET
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 15
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 1Gi

---
# Gateway ClusterIP Service
apiVersion: v1
kind: Service
metadata:
  name: osf-gateway
  namespace: osf
  labels:
    app: osf-gateway
spec:
  selector:
    app: osf-gateway
  ports:
    - port: 8080
      name: http

---
# Gateway NodePort REMOVED (Security Audit: direct LAN access bypasses CF)
# Use cloudflared tunnel for external access instead.
# For dev access: kubectl port-forward svc/osf-gateway 8080:8080 -n osf
